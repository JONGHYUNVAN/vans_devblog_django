# =============================================================================
# CloudType.io 배포 설정 파일
# =============================================================================

name: vans-devblog-search-service
version: "1.0"

# 런타임 설정
runtime:
  language: python
  version: "3.11"

# 빌드 설정
build:
  # 빌드 단계에서 실행할 명령어
  commands:
    - pip install --upgrade pip
    - pip install -r requirements.txt

  # 빌드 환경 변수
  environment:
    - DJANGO_SETTINGS_MODULE=vans_search_service.settings.cloudtype
    - PYTHONUNBUFFERED=1
    - PYTHONDONTWRITEBYTECODE=1

# 배포 설정
deploy:
  # 배포 전 실행할 명령어
  pre_deploy:
    - python manage.py makemigrations
    - python manage.py migrate
    - python manage.py collectstatic --noinput

  # 메인 애플리케이션 시작 명령어
  start:
    command: gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 vans_search_service.wsgi:application

  # 헬스체크 설정
  health_check:
    path: /api/v1/search/health/
    interval: 30
    timeout: 10
    retries: 3

# 리소스 설정
resources:
  # 메모리 및 CPU 설정
  memory: 512Mi # CloudType 무료 플랜 기준
  cpu: 0.5 # CloudType 무료 플랜 기준

  # 디스크 설정
  disk: 1Gi

# 환경 변수 (CloudType 대시보드에서 설정)
environment:
  # Django 기본 설정
  - name: DJANGO_SETTINGS_MODULE
    value: vans_search_service.settings.cloudtype

  - name: DEBUG
    value: "False"

  - name: PYTHONUNBUFFERED
    value: "1"

  - name: PYTHONDONTWRITEBYTECODE
    value: "1"

# 네트워크 설정
network:
  # 포트 설정 (CloudType에서 자동 할당)
  ports:
    - name: http
      port: 8000
      target_port: 8000
      protocol: TCP

# 스케일링 설정
scaling:
  min_instances: 1
  max_instances: 3
  target_cpu_utilization: 70

# 로그 설정
logging:
  level: INFO
  retention: 7d # 7일간 로그 보관

# 모니터링 설정
monitoring:
  enabled: true
  metrics:
    - cpu
    - memory
    - disk
    - network
    - response_time
